name: debug

content:
  rpms:
    - dnf
    - gdb
    - gdb-gdbserver
    - openssh-server
  make_dirs:
    - path: /etc/containers/systemd/qm.container.d/
      parents: true
      exist_ok: true
  add_files:
    - path: /etc/containers/systemd/qm.container.d/publish-port.conf
      text: |
        [Container]
        PublishPort=3456:3456
    - path: /usr/lib/systemd/system/gdbserver.service
      text: |
        [Unit]
        Description=GDB Server for Remote Debugging
        After=network.target

        [Service]
        Type=simple
        ExecStart=/usr/bin/gdbserver --multi --debug :2345 
        Restart=always
        User=root
        Group=root

        [Install]
        WantedBy=multi-user.target
    - path: /root/.ssh/authorized_keys
      source_path: /root/.ssh/debug.pub
  chmod_files:
    - path: /root/.ssh/authorized_keys
      mode: "0644"
      recursive: false
  chown_files:
    - path: /root/.ssh/authorized_keys
      user: root
      group: root
      recursive: false

qm:
  memory_limit:
    max: 50%
    high: 50%
  content:
    rpms:
      - dnf
      - gdb
      - gdb-gdbserver
    add_files:
      - path: /usr/lib/systemd/system/gdbserver.service
        text: |
          [Unit]
          Description=GDB Server for Remote Debugging
          After=network.target

          [Service]
          Type=simple
          ExecStart=/usr/bin/gdbserver --multi --debug :3456
          Restart=always
          User=root
          Group=root

          [Install]
          WantedBy=multi-user.target

network:
  static: {}

image:
  image_size: 9 GiB
  partitions:
    boot:
      size: 300 MiB
    var:
      relative_size: 0.3

auth:
  sshd_config:
    PasswordAuthentication: false
    PermitRootLogin: true

kernel:
  debug_logging: true

